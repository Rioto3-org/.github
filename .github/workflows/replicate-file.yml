name: Replicate File

on:
  workflow_dispatch:
    inputs:
      target_owner:
        description: "Target repository owner"
        required: true
        type: string
      target_repo:
        description: "Target repository name"
        required: true
        type: string
      overwrite:
        description: "Overwrite if exists (true/false)"
        required: false
        default: "false"
        type: string

permissions:
  contents: write

jobs:
  replicate:
    runs-on: ubuntu-latest
    steps:
      - name: Replicate initialize-request.yml
        uses: actions/github-script@v7
        env:
          SOURCE_OWNER: Rioto3
          SOURCE_REPO: .github
          SOURCE_PATH: .github/workflows/initialize-request.yml
          TARGET_OWNER: ${{ github.event.inputs.target_owner }}
          TARGET_REPO: ${{ github.event.inputs.target_repo }}
          OVERWRITE: ${{ github.event.inputs.overwrite }}
        with:
          github-token: ${{ secrets.REPLICATION_TOKEN }}
          script: |
            const owner = process.env.SOURCE_OWNER;
            const repo = process.env.SOURCE_REPO;
            const path = process.env.SOURCE_PATH;
            const targetOwner = process.env.TARGET_OWNER;
            const targetRepo = process.env.TARGET_REPO;
            const overwrite = process.env.OVERWRITE === "true";

            // 1. Get source file
            const sourceRes = await github.rest.repos.getContent({
              owner,
              repo,
              path
            });
            
            if (sourceRes.data.type !== "file") {
              throw new Error("Source path is not a file");
            }
            
            const content = sourceRes.data.content;

            // 2. Get target default branch
            const repoInfo = await github.rest.repos.get({
              owner: targetOwner,
              repo: targetRepo
            });
            const defaultBranch = repoInfo.data.default_branch;

            // 3. Check if file exists in target
            let existingSha = null;
            try {
              const existingRes = await github.rest.repos.getContent({
                owner: targetOwner,
                repo: targetRepo,
                path
              });
              existingSha = existingRes.data.sha;
            } catch (e) {
              if (e.status !== 404) throw e;
            }

            if (existingSha && !overwrite) {
              throw new Error("File already exists in target repository. Set overwrite=true to replace it.");
            }

            // 4. Create or update in target
            await github.rest.repos.createOrUpdateFileContents({
              owner: targetOwner,
              repo: targetRepo,
              path,
              message: `chore: replicate ${path} from ${owner}/${repo}`,
              content,
              branch: defaultBranch,
              ...(existingSha ? { sha: existingSha } : {})
            });
            
            core.info("Replication completed.");
